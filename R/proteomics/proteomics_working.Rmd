---
title: "proteomics_parse_working"
author: "HCW"
date: "12/15/2019"
output: html_document
---

```{r}
library(tidyverse)
library(ggplot2)
library(magrittr)
library(matrixStats)
library(vegan)
library(nlme)
```


Import data
```{r}
save_path_figures <- "../../plots/"
save_path_proteomics <- "../../data/proteomics/cleaned/"

#unfiltered protein dataframes
proteo_host_gather_norm <- readRDS(file = paste(save_path_proteomics, "proteo_host_gather_norm.rds", sep = ""))

proteo_microbe_sum_desc_gather_norm <- readRDS(file = paste(save_path_proteomics, "proteo_microbe_sum_desc_gather_norm.rds", sep = ""))
microbe_description_key <- proteo_microbe_sum_desc_gather_norm %>% 
  ungroup() %>% 
  select(Description,Description_ID) %>% 
  unique

#filtered protein data frames
proteo_host_diff_filt <- readRDS(file = paste(save_path_proteomics, "proteo_host_diff_filt.rds", sep = ""))
proteo_host_diff_filt_fiber <- readRDS(file = paste(save_path_proteomics, "proteo_host_diff_filt_fiber.rds", sep = ""))
proteo_host_diff_filt_fermented <- readRDS(file = paste(save_path_proteomics, "proteo_host_diff_filt_fermented.rds", sep = ""))
proteo_microbe_desc_diff_filt <- readRDS(file = paste(save_path_proteomics, "proteo_microbe_desc_diff_filt.rds", sep = ""))
proteo_microbe_desc_diff_filt_fiber <- readRDS(file = paste(save_path_proteomics, "proteo_microbe_desc_diff_filt_fiber.rds", sep = ""))
proteo_microbe_desc_diff_filt_fermented <- readRDS(file = paste(save_path_proteomics, "proteo_microbe_desc_diff_filt_fermented.rds", sep = ""))

proteo_host_filt <- readRDS(file = paste(save_path_proteomics, "proteo_host_filt.rds", sep = ""))
proteo_host_filt_fiber <- readRDS(file = paste(save_path_proteomics, "proteo_host_filt_fiber.rds", sep = ""))
proteo_host_filt_fermented <- readRDS(file = paste(save_path_proteomics, "proteo_host_filt_fermented.rds", sep = ""))
proteo_microbe_desc_filt <- readRDS(file = paste(save_path_proteomics, "proteo_microbe_desc_filt.rds.rds", sep = ""))
proteo_microbe_desc_filt_fiber <- readRDS(file = paste(save_path_proteomics, "proteo_microbe_desc_filt_fiber.rds", sep = ""))
proteo_microbe_desc_filt_fermented <- readRDS(file = paste(save_path_proteomics, "proteo_microbe_desc_filt_fermented.rds", sep = ""))
```


Paired siggenes difference in host proteins (tp 1 vs. tp 7 fiber and fermented groups)
-none sig.
```{r}
#fiber diff tp2 vs. tp7
proteo_host_filt_fiber_1 <- proteo_host_filt_fiber %>% 
  filter(Timepoint==1) %>% 
  arrange(Participant)
proteo_host_filt_fiber_7 <- proteo_host_filt_fiber %>% 
  filter(Timepoint==7)%>% 
  arrange(Participant)
proteo_host_filt_fiber_1_7 <- bind_rows(proteo_host_filt_fiber_1,proteo_host_filt_fiber_7)

set.seed(20)
siggenes_cl <- c((-1:-13), 1:13)
siggenes_data <- t(proteo_host_filt_fiber_1_7[-c(1:3)]) 
siggenes_output <- siggenes::sam(data=siggenes_data,cl=siggenes_cl)
summary(siggenes_output)
delta_siggenes <- findDelta(siggenes_output, fdr = 0.05)

#fermented diff tp2 vs. tp7
proteo_host_filt_fermented_1 <- proteo_host_filt_fermented %>% 
  filter(Timepoint==1) %>% 
  arrange(Participant)
proteo_host_filt_fermented_7 <- proteo_host_filt_fermented %>% 
  filter(Timepoint==7)%>% 
  arrange(Participant)
proteo_host_filt_fermented_1_7 <- bind_rows(proteo_host_filt_fermented_1,proteo_host_filt_fermented_7)

set.seed(20)
siggenes_cl <- c((-1:-14), 1:14)
siggenes_data <- t(proteo_host_filt_fermented_1_7[-c(1:3)])
siggenes_output <- siggenes::sam(data=siggenes_data,cl=siggenes_cl)
summary(siggenes_output)
delta_siggenes <- findDelta(siggenes_output, fdr = 0.05)
```

Paired siggenes difference in microbe proteins (tp 1 vs. tp 7 fiber and fermented groups)
-none sig.
```{r}
#fiber diff tp2 vs. tp7
proteo_microbe_desc_filt_fiber_1 <- proteo_microbe_desc_filt_fiber %>% 
  filter(Timepoint==1) %>% 
  arrange(Participant)
proteo_microbe_desc_filt_fiber_7 <- proteo_microbe_desc_filt_fiber %>% 
  filter(Timepoint==7)%>% 
  arrange(Participant)
proteo_microbe_desc_filt_fiber_1_7 <- bind_rows(proteo_microbe_desc_filt_fiber_1,proteo_microbe_desc_filt_fiber_7)

set.seed(20)
siggenes_cl <- c((-1:-13), 1:13)
siggenes_data <- t(proteo_microbe_desc_filt_fiber_1_7[-c(1:3)]) 
siggenes_output <- siggenes::sam(data=siggenes_data,cl=siggenes_cl)
summary(siggenes_output)
delta_siggenes <- findDelta(siggenes_output, fdr = 0.05)

#fermented diff tp2 vs. tp7
proteo_microbe_desc_filt_fermented_1 <- proteo_microbe_desc_filt_fermented %>% 
  filter(Timepoint==1) %>% 
  arrange(Participant)
proteo_microbe_desc_filt_fermented_7 <- proteo_microbe_desc_filt_fermented %>% 
  filter(Timepoint==7)%>% 
  arrange(Participant)
proteo_microbe_desc_filt_fermented_1_7 <- bind_rows(proteo_microbe_desc_filt_fermented_1,proteo_microbe_desc_filt_fermented_7)

set.seed(20)
siggenes_cl <- c((-1:-14), 1:14)
siggenes_data <- t(proteo_microbe_desc_filt_fermented_1_7[-c(1:3)])
siggenes_output <- siggenes::sam(data=siggenes_data,cl=siggenes_cl)
summary(siggenes_output)
delta_siggenes <- findDelta(siggenes_output, fdr = 0.05)
```

LME for each protein across time
-none even close to sig.
```{r}
LME_one_by_one_function <- function(df,names_vector,y_value_col){
  pValueList <- c()
  xList <- c()
  correValueList <- c()
  stdEList <-c()
  intList <- c()
  for (i in names_vector){
    newdf <- data.frame(out = df[,y_value_col], 
                        xColName = df[, i], 
                        id = df[,"Participant"])
    #print(newdf)
    colnames(newdf)[2] <- "xColName"
    lmeData <- lme(out ~ xColName, data = newdf,random = ~1|id,na.action = na.omit)
    pVal = summary(lmeData)$tTable[2,5]
    corre = summary(lmeData)$tTable[2,1]
    stdE = summary(lmeData)$tTable[2,2]
    intercept = summary(lmeData)$tTable[1,1]
    xList <- c(xList,i)
    pValueList <- c(pValueList,pVal)
    correValueList <- c(correValueList,corre)
    stdEList <- c(stdEList,stdE)
    intList <- c(intList,intercept)
  }
  LME_pTable <- data.frame(xColName = xList,
                           correlation = correValueList,
                           pValue = pValueList,
                           pValueAdj = p.adjust(pValueList,method="BH"),
                           intercept=intList,stdE=stdEList)
  return(LME_pTable)
}

#host protein
proteo_host_fiber_list <- proteo_host_filt_fiber %>% 
  select(-Participant,-Group,-Timepoint) %>% 
  colnames
proteo_host_fiber_LME <- LME_one_by_one_function(select(proteo_host_filt_fiber,-Group),proteo_host_fiber_list,"Timepoint")

proteo_host_fermented_list <- proteo_host_filt_fermented %>% 
  select(-Participant,-Group,-Timepoint) %>% 
  colnames
proteo_host_fermented_LME <- LME_one_by_one_function(select(proteo_host_filt_fermented,-Group),proteo_host_fermented_list,"Timepoint")

#microbe
proteo_microbe_fiber_list <- proteo_microbe_desc_filt_fiber %>% 
  ungroup() %>% 
  select(-Participant,-Group,-Timepoint) %>% 
  colnames
working_df <- proteo_microbe_desc_filt_fiber %>% 
  ungroup() %>% 
  select(-Group) %>% 
  as.data.frame()
proteo_microbe_fiber_LME <- LME_one_by_one_function(working_df,proteo_microbe_fiber_list,"Timepoint")

proteo_microbe_fermented_list <- proteo_microbe_desc_filt_fermented %>% 
  ungroup() %>% 
  select(-Participant,-Group,-Timepoint) %>% 
  colnames
working_df <- proteo_microbe_desc_filt_fermented %>% 
  ungroup() %>% 
  select(-Group) %>% 
  as.data.frame()
proteo_microbe_fermented_LME <- LME_one_by_one_function(working_df,proteo_microbe_fermented_list,"Timepoint")
```

Calculate percentage of microbe and host proteins at each timepoint 
```{r}
proteo_host_sum_log_norm <- proteo_host_gather_norm %>% 
  select(Participant,Group,Timepoint,sample_protein_sum) %>% 
  unique() %>% 
  dplyr::rename(host_protein_sum=sample_protein_sum)

proteo_microbe_sum_log_norm <- proteo_microbe_sum_desc_gather_norm %>% 
  select(Participant,Group,Timepoint,sample_protein_sum) %>% 
  unique() %>% 
  dplyr::rename(microbe_protein_sum=sample_protein_sum)

proteo_sum_log_norm <- left_join(proteo_host_sum_log_norm,proteo_microbe_sum_log_norm) %>% 
  mutate(all_sum=host_protein_sum+microbe_protein_sum,
         host_percent=host_protein_sum/all_sum,
         microbe_percent=microbe_protein_sum/all_sum) 

#LME for fiber group - microbe percent over time
proteo_sum_log_norm_fiber <- proteo_sum_log_norm %>% 
  filter(Group=="Fiber") %>% 
  arrange(Participant)
fiber_microbe_protein_sum_LME <- lme(microbe_percent~Timepoint,data=filter(proteo_sum_log_norm_fiber,Timepoint!=1),random=~1|Participant)
summary(fiber_microbe_protein_sum_LME)$tTable

proteo_sum_log_norm_fiber$Timepoint %<>% as.factor
ggplot(proteo_sum_log_norm_fiber,aes(x=Timepoint,y=microbe_percent))+
  geom_boxplot()

#compare just the first baseline timepoint and last maintenance timepoint
t.test(filter(proteo_sum_log_norm_fiber,Timepoint==1)$microbe_percent,filter(proteo_sum_log_norm_fiber,Timepoint==7)$microbe_percent,paired=TRUE)
proteo_sum_log_norm_fiber$Participant %<>% as.integer
ggplot(filter(proteo_sum_log_norm_fiber,Timepoint %in% c(1,7)),aes(x=Timepoint,y=microbe_percent,col=Participant,group=Participant))+
  geom_line()+
  geom_point()+
  theme_bw()+
  scale_colour_gradient(low="#99D594",high="#99D594")+
  scale_x_discrete(breaks=c(1,2,3,4,5,6,7,8,9),labels=c("-2","0","2", "4","6", "8","10","12","14"),name="Timepoint (weeks)")+
  ylab("Percentage Microbe Proteins")
#ggsave(paste(save_path_figures,"proteomics_fiber_microbe_percent.pdf"),width = 3.5,height=4,useDingbats=FALSE)

# LME for fermented - timepoint vs. microbe percentage
proteo_sum_log_norm_fermented <- proteo_sum_log_norm %>% 
  filter(Group=="Fermented")
fermented_microbe_protein_sum_LME <-lme(microbe_percent~Timepoint,data=filter(proteo_sum_log_norm_fermented,Timepoint!=1),random=~1|Participant)
summary(fermented_microbe_protein_sum_LME)$tTable
t.test(filter(proteo_sum_log_norm_fermented,Timepoint==1)$microbe_percent,filter(proteo_sum_log_norm_fermented,Timepoint==7)$microbe_percent,paired=TRUE)

proteo_sum_log_norm_fermented$Timepoint %<>% as.factor
ggplot(proteo_sum_log_norm_fermented,aes(x=Timepoint,y=microbe_percent))+
  geom_boxplot()
```

Does fiber intake vary with microbe protein percentage?
```{r}
#fiber intake total
save_path_diet <- "../../data/diet/cleaned/"
fiber_grouping_total_intake <- readRDS(paste(save_path_diet,"fiber_g_intake.rds")) %>% 
  filter(Group=="Fiber") %>% 
  mutate(Participant = as.factor(as.character(Participant))) %>% 
  inner_join(.,proteo_sum_log_norm_fiber)

fiber_microbe_percent_lme <- lme(microbe_percent~fiber_g,data=fiber_grouping_total_intake,random=~1|Participant,na.action=na.omit)
summary(fiber_microbe_percent_lme)$tTable
fiber_intercept=summary(fiber_microbe_percent_lme)$tTable[1,1]
fiber_coeficient=summary(fiber_microbe_percent_lme)$tTable[2,1]

ggplot(fiber_grouping_total_intake,aes(x=fiber_g,y=microbe_percent))+
  geom_point()+
  theme_bw()+
  geom_abline(intercept=fiber_intercept,slope=fiber_coeficient)

#fiber groups
fiber_grouping_intake <- readRDS(paste(save_path_diet,"fiber_grouping_intake.rds")) %>% 
  filter(Group=="Fiber") %>% 
  mutate(Timepoint_category=ifelse(Timepoint==2,"Baseline",
                                   ifelse(Timepoint==4,"Ramp",
                                          ifelse(Timepoint==7,"Maint","Washout")))) %>% 
  mutate(Participant = as.factor(as.character(Participant)))

fiber_grouping_intake_proteo <- proteo_sum_log_norm_fiber %>% 
  mutate(Timepoint_category=ifelse(Timepoint==2,"Baseline",
                                   ifelse(Timepoint==4,"Ramp",
                                          ifelse(Timepoint==7,"Maint","Washout")))) %>% 
  select(-Timepoint) %>% 
  left_join(.,fiber_grouping_intake)
fiber_type_list <- unique(fiber_grouping_intake_proteo$Category)
pvalue_list=c()
for(i in fiber_type_list){
  df_working=fiber_grouping_intake_proteo %>% 
    filter(Category==i)
  print(i)
  lme_obj=lme(microbe_percent~Fiber_by_category_averaged,data=df_working,random=~1|Participant)
  pvalue=summary(lme_obj)$tTable[2,5]
  pvalue_list=c(pvalue_list,pvalue)
}
fiber_type_microbe_protein <- data.frame(fiber_category=fiber_type_list,
                                         pvalue=pvalue_list)
```

```{r}
unpairedYSAM <- function(df1,df2){
  y = c(rep(1,dim(df1)[1]),rep(2,dim(df2)[1]))
  return(y)
}

unpairedXSAM <- function(df1,df2,startIDs,endIDs){
  x1 = t(df1[-c(startIDs:endIDs)])
  #print(head(x1))
  x2 = t(df2[-c(startIDs:endIDs)])
  #print(head(x2))
  x_all <- cbind(x1,x2) 
  #print(x_all)
  return(x_all)
}

proteo_host_diff_filt_unpaired_fiber_7 <- proteo_host_diff_filt %>% 
  filter(Group=="Fiber" & Timepoint==7)
proteo_host_diff_filt_unpaired_fermented_7 <- proteo_host_diff_filt %>% 
  filter(Group=="Fermented" & Timepoint==7)
#host
set.seed(20)
siggenes_input_data <- unpairedXSAM(proteo_host_diff_filt_unpaired_fiber_7,proteo_host_diff_filt_unpaired_fermented_7,1,3)
siggenes_input_cl <- unpairedYSAM(proteo_host_diff_filt_unpaired_fiber_7,proteo_host_diff_filt_unpaired_fermented_7)
siggenes_output <- siggenes::sam(data=siggenes_input_data,cl=siggenes_input_cl)
summary(siggenes_output)
delta_siggenes <- findDelta(siggenes_output, fdr = 0.05)

#microbe
proteo_microbe_diff_filt_unpaired_fiber_7 <- proteo_microbe_desc_diff_filt %>% 
  filter(Group=="Fiber" & Timepoint==7)
proteo_microbe_diff_filt_unpaired_fermented_7 <- proteo_microbe_desc_diff_filt %>% 
  filter(Group=="Fermented" & Timepoint==7)
set.seed(20)
siggenes_input_data <- unpairedXSAM(proteo_microbe_diff_filt_unpaired_fiber_7,proteo_microbe_diff_filt_unpaired_fermented_7,1,3)
siggenes_input_cl <- unpairedYSAM(proteo_microbe_diff_filt_unpaired_fiber_7,proteo_microbe_diff_filt_unpaired_fermented_7)
siggenes_output <- siggenes::sam(data=siggenes_input_data,cl=siggenes_input_cl)
summary(siggenes_output)
delta_siggenes <- findDelta(siggenes_output, fdr = 0.05)
siggenes_df <- summary(siggenes_output,delta_siggenes[2])
siggenes_mat.sig_fiber_fermented_microbe <- siggenes_df@mat.sig %>%
  filter(q.value <= 0.1) %>%
  mutate(metabolite = rownames(siggenes_df@mat.sig)[c(1:dim(.)[1])]) %>%
  select(metabolite,q.value) 

proteo_microbe_sum_diff_fiber_fermented_sigg <- proteo_microbe_desc_diff_filt %>% 
  gather(key=Description_ID,value=avg_log_norm,-Participant,-Group,-Timepoint) %>% 
  filter(Description_ID %in% siggenes_mat.sig_fiber_fermented_microbe$metabolite)
proteo_microbe_sum_diff_fiber_fermented_sigg$Timepoint %<>% as.factor
ggplot(proteo_microbe_sum_diff_fiber_fermented_sigg,aes(x=Timepoint,y=avg_log_norm,fill=Group))+
  geom_boxplot()+
  facet_wrap(~Description_ID,scales="free")
ggplot(filter(proteo_microbe_sum_diff_fiber_fermented_sigg,Timepoint==7),aes(x=Description_ID,y=avg_log_norm,fill=Group))+
  geom_boxplot()+
  theme_bw()+
  scale_fill_manual(breaks=c("Group1","Group3"),values=c("#d6604d","#4393c3"))+
  ylab("log2 normalized metabolite change from Week -2")+
  xlab("Microbial protein")
#ggsave(paste(save_path_figures,"fiber_inflamm_groups_microbial_proteins_unpaired_diff.pdf"),width = 5,height=4,useDingbats=FALSE)
```
